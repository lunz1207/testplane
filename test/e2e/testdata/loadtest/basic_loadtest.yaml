---
apiVersion: infra.testplane.io/v1alpha1
kind: LoadTest
metadata:
  name: e2e-loadtest-basic
  namespace: default
  labels:
    app.kubernetes.io/managed-by: testplane-e2e
spec:
  target:
    resource:
      manifest:
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: e2e-loadtest-target
          namespace: default
          labels:
            app.kubernetes.io/managed-by: testplane-e2e
            app: e2e-loadtest-target
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: e2e-loadtest-target
          template:
            metadata:
              labels:
                app: e2e-loadtest-target
            spec:
              containers:
                - name: nginx
                  image: library/nginx:1.14
                  ports:
                    - containerPort: 80
    readyCondition:
      timeoutSeconds: 120
      allOf:
        - function: ResourceExists
  workload:
    resources:
      - manifest:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: e2e-loadtest-workload
            namespace: default
            labels:
              app.kubernetes.io/managed-by: testplane-e2e
              app: e2e-loadtest-workload
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: e2e-loadtest-workload
            template:
              metadata:
                labels:
                  app: e2e-loadtest-workload
              spec:
                containers:
                  - name: busybox
                    image: library/busybox:1.31.1
                    command: ["/bin/sh", "-c", "while true; do echo 'running load test'; sleep 10; done"]
  healthCheck:
    failureThreshold: 3
    intervalSeconds: 30
    allOf:
      - function: ResourceExists
