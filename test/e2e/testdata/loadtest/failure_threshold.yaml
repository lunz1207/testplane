---
apiVersion: infra.testplane.io/v1alpha1
kind: LoadTest
metadata:
  name: e2e-loadtest-failure-threshold
  namespace: default
  labels:
    app.kubernetes.io/managed-by: testplane-e2e
spec:
  target:
    template:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: e2e-loadtest-fail-target
        namespace: default
        labels:
          app.kubernetes.io/managed-by: testplane-e2e
          app: e2e-loadtest-fail-target
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: e2e-loadtest-fail-target
        template:
          metadata:
            labels:
              app: e2e-loadtest-fail-target
          spec:
            containers:
              - name: nginx
                image: library/nginx:1.14
                ports:
                  - containerPort: 80
    readyCondition:
      timeoutSeconds: 120
      allOf:
        - function: ResourceExists
  workload:
    resources:
      templates:
        - template:
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              name: e2e-loadtest-fail-workload
              namespace: default
              labels:
                app.kubernetes.io/managed-by: testplane-e2e
                app: e2e-loadtest-fail-workload
            spec:
              replicas: 1
              selector:
                matchLabels:
                  app: e2e-loadtest-fail-workload
              template:
                metadata:
                  labels:
                    app: e2e-loadtest-fail-workload
                spec:
                  containers:
                    - name: busybox
                      image: library/busybox:1.31.1
                      command: ["/bin/sh", "-c", "while true; do sleep 30; done"]
  # Expectations that will fail - checking that target resource does NOT exist (but it does)
  expectations:
    failureThreshold: 2  # Fail after 2 consecutive failures
    intervalSeconds: 5   # Check every 5 seconds for faster failure
    allOf:
      - function: ResourceNotExists
